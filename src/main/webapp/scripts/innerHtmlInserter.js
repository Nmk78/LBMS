/**
 * Script for Nav
 * 
 * USAGE :     <div id="nav"/> (An element with ID = "nav" ) must have in host HTML page
 * 
 * How it work? : Inner HTML that are generated by mode are go into modal!
 * 
 * How it change mode? : Change URL param and it trigger UI updates.

 */


const navContainer = document.getElementById("nav");

let isLoggedIn = localStorage.getItem("isLoggedIn");
let role = localStorage.getItem("role");

const url = new URL(window.location);
path = url.pathname.split("/");
currentRoute = path[path.length - 1];


const navInnerHtml = `      <div id="logo" class="w-1/3">
        <a href="/LBMS/" id="logo" class="w-16 h-16 flex items-center">
          <img src="assets/logo/logo.png" alt="Logo" class="w-16 h-16" />
        </a>
      </div>

      <div class="flex items-center w-auto h-2/3 space-x-10 mb-2">
        <a
          href="/LBMS/#"
          class="text-[--secondary] font-semibold text-xl hover:underline underline-offset-2 ${currentRoute == "index.html" ? "underline": currentRoute == "" ? "underline": ""}"
          >Home</a
        >
        <a
          href="/LBMS/posts"
          class="text-[--secondary] font-semibold text-xl hover:underline underline-offset-2 ${currentRoute == "posts" ? "underline": ""}"
          >Announcement</a
        >        
        <a
          href="/LBMS/category?category=all"
          class="text-[--secondary] font-semibold text-xl hover:underline underline-offset-2 ${currentRoute == "category" ? "underline": ""}"
          >Category</a
        >
        <a
          href="/LBMS/about.html"
          class="text-[--secondary] font-semibold text-xl hover:underline underline-offset-2 ${currentRoute == "about.html" ? "underline": ""}"
          >About</a
        >
      </div>
      <div class="flex items-center justify-end w-1/3 h-2/3 space-x-3 mb-2">
        <form
          class="flex w-[25ch] focus-within:w-auto h-full items-center"
          action="/LBMS/bookSearch"
        >
          <input
            type="text"
            id="search"
            name="search"
            placeholder="Search books..."
            class="px-2 py-[6px] w-full transition-transform duration-1000 h-2/3 rounded-none border-b-2 border-[--secondary] focus:outline-none"
          />

          <button
            type="submit"
            class="h-2/3 border-b-2 py-[5px] px-3 flex items-center border-[--secondary] bg-[--secondary] text-gray-200 text-center"
          >
            Search
          </button>
        </form>
       ${isLoggedIn ? `
		    <a href="${role === 'admin' ? '/LBMS/admin.jsp' : '/LBMS/user.jsp'}" id="userProfile" class="h-full">
		        <img src="assets/img/avatar.svg" alt="User Profile" class="h-16" />
		    </a>
		` : `
		    <button
		        id="openModalBtn"
		        class="h-2/3 border-b-2 py-[5px] px-3 flex items-center border-[--secondary] bg-[--secondary] text-gray-200 text-center"
		    >
		        Sign In
		    </button>
		`}
      </div>`;

navContainer.innerHTML = navInnerHtml;

/**
 * Script for authentication
 * 
 * USAGE :     <div id="modal"/> (An element with ID = "modal" ) must have in host HTML page
 * 
 * How it work? : Inner HTML that are generated by mode are go into modal!
 * 
 * How it change mode? : Change URL param and it trigger UI updates.

 */

// function(mode){
//   return innerhtml with model
// }

const openModalBtn = document.getElementById("openModalBtn");
const modal = document.getElementById("modal");

const getModalContent = (mode, err = "", email = "", name="", phone="", idOrDept="") => `
  <div id="" class="fixed z-50 inset-0 bg-black bg-opacity-50 flex flex-col justify-center items-center">
    <div class="relative bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
      <button id="authClose" class="absolute top-4 right-5 hover:bg-gray-300 rounded-sm px-4 py-2">
        Close
      </button>
      <h1 class="text-2xl font-bold mb-6 text-center text-[--secondary]">${
        mode === "SignUp" ? "Sign Up" : mode === "SignIn" ? "Sign In" : "Error"
      }</h1>
      <form action="authServlet" method="POST" class="space-y-4">
        ${
          mode === "SignUp"
            ? `
        <div>
          <label for="name" class="block text-sm font-medium text-[--secondary]">Name</label>
          <input type="text" id="name" name="name" value="${name == null ? "" : name}" class="mt-1 p-2 w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[--primary] focus:border-[--primary]">
        </div>` : ""
        }
        <div>
          <label for="email" class="block text-sm font-medium text-[--secondary]">Email</label>
          <input type="email" id="email" name="email" value="${email == null ? "" : email}" class="mt-1 p-2 w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[--primary] focus:border-[--primary]">
        </div>
        ${
          mode === "SignUp"
            ? `
         <div>
          <label for="phone" class="block text-sm font-medium text-[--secondary]">Phone</label>
          <input type="tel" id="phone" name="phone" value="${phone == null ? "" : phone}" class="mt-1 p-2 w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[--primary] focus:border-[--primary]">
        </div>
        <div>
          <label for="userType" class="block text-sm font-medium text-[--secondary]">User Type</label>
          <div class="flex mt-1">
              <select
                id="userType"
                name="userType"
                class="mt-1 w-1/3 p-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-[--primary] focus:border-[--primary]"
              >
                <option value="KPTMYK">ID</option>
                <option value="staff">Staff</option>
              </select>
              <input
                type="text"
                id="idOrDept"
                name="idOrDept"
                value="${idOrDept == null ? "" : idOrDept}"
                class="mt-1 p-2 w-2/3 border border-gray-300 rounded-r-md focus:outline-none focus:ring-2 focus:ring-[--primary] focus:border-[--primary]"
                placeholder="Enter ID"
              />
          </div>
        </div>
        <input type="hidden" name="mode" value="SignUp">
        `
            : `<input type="hidden" name="mode" value="SignIn">`
        }
        <div>
          <label for="password" class="block text-sm font-medium text-[--secondary]">Password</label>
          <input type="password" id="password" name="password" class="mt-1 p-2 w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[--primary] focus:border-[--primary]">
        </div>
        
        ${
	        err
	          ? `<p class="text-red-500 mb-4">${err}</p>`
	          : ""
       }
        <button type="submit" class="w-full py-2 px-4 bg-[--secondary] text-white font-semibold rounded-md hover:bg-[--secondary] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[--primary]">${
          mode === "SignUp" ? "Sign Up" : "Sign In"
        }</button>
      </form>
      <div class="space-y-2 text-xs text-right space-x-1">
		${
      mode === "SignIn"
        ? `<span>Don't have an account?</span><button id="signUp" class="underline">Sign Up</button>`
        : `<span>Already have an account?</span><button id="signIn" class="underline">Sign In</button>`
    }
      </div>
    </div>
  </div>
`;

// Usage example:
// const modalContent = getModalContent('SignIn', 'Incorrect password', {email: 'user@example.com'});

const updateURL = (mode) => {
  const url = new URL(window.location);
  url.searchParams.set("mode", mode);
  window.history.pushState({}, "", url);
};

function authModalToggler(mode, err, email, name, phone, idOrDept) {
    const modalContent = getModalContent(mode, err, email, name, phone, idOrDept);
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalContent;
    document.body.appendChild(modalContainer);

    const authClose = document.getElementById("authClose");
    if (authClose) {
        authClose.addEventListener("click", () => {
            modalContainer.remove();
        });
    }

    const toggleButton = mode === "SignIn" ? document.getElementById("signUp") : document.getElementById("signIn");
    if (toggleButton) {
        toggleButton.addEventListener("click", () => {
            modalContainer.remove();
            authModalToggler(mode === "SignIn" ? "SignUp" : "SignIn");
        });
    }

    // Handle disabling input box based on userType selection
  const userTypeSelect = document.getElementById("userType");
  const idOrDeptInput = document.getElementById("idOrDept");

  if (userTypeSelect && idOrDeptInput) {
    userTypeSelect.addEventListener("change", function() {
      if (userTypeSelect.value === "staff") {
        //idOrDeptInput.classList.add("hidden"); // Hide the input box
        idOrDeptInput.placeholder = "ID will be generated automatically.";
		idOrDeptInput.disabled = true;
      } else {
        idOrDeptInput.classList.remove("hidden"); // Show the input box
        idOrDeptInput.placeholder = "Enter ID";
      }
    });

    // Set the initial state based on the current selection
    if (userTypeSelect.value === "staff") {
      //idOrDeptInput.classList.add("hidden"); // Hide the input box
      idOrDeptInput.placeholder = "ID will be generated automatically.";
	  idOrDeptInput.disabled = true;
    } else {
      idOrDeptInput.classList.remove("hidden"); // Show the input box
      idOrDeptInput.placeholder = "Enter ID";
    }
  }

}



if (openModalBtn) {
  openModalBtn.addEventListener("click", () => {
    const mode = openModalBtn.textContent.trim().replace(" ", "");
    authModalToggler(mode);
  });
}



////Footer

const footerInnerHtml = `        <div id="top" class="flex">
          <div id="left" class="w-1/3 flex justify-center items-center">
            <img
              src="./assets/logo/logo.png"
              class="w-52 h-full aspect-square"
              alt="logo"
            />
          </div>
          <div id="right" class="w-2/3 flex justify-around">
            <div class="">
              <p id="title" class="text-xl font-semibold text-[--text]">
                Quick Links
              </p>
              <div
                id="links"
                class="flex flex-col justify-center items-start space-y-2 mt-4"
              >
                <a href="/" class="text-md font-light hover:opacity-80">Home</a>
                <a href="/" class="text-md font-light hover:opacity-80"
                  >Articles</a
                >
                <a href="/" class="text-md font-light hover:opacity-80"
                  >Category</a
                >
                <a href="/" class="text-md font-light hover:opacity-80"
                  >About</a
                >
                <button
                  id="openModalBtn"
                  class="text-md font-light hover:opacity-80"
                >
                  Sign In
                </button>
                <button
                  id="openModalBtn"
                  class="text-md font-light hover:opacity-80"
                >
                  Sign Up
                </button>
              </div>
            </div>
            <div>
              <p id="title" class="text-xl font-semibold text-[--text]">
                Get In Touch
              </p>
              <div
                id="links"
                class="flex flex-col justify-center space-y-2 mt-4"
              >
                <a href="/" class="text-md font-light hover:opacity-80">Home</a>
                <a href="/" class="text-md font-light hover:opacity-80"
                  >Articles</a
                >
                <a href="/" class="text-md font-light hover:opacity-80"
                  >Category</a
                >
              </div>
            </div>
            <div>
              <p id="title" class="text-xl font-semibold text-[--text]">
                Location
              </p>
              <div
                id="links"
                class="flex flex-col justify-center space-y-2 mt-4"
              >
                <p class="text-md font-light hover:opacity-80">
                  Myeik-Tanithary Highway Road
                </p>
                <p class="text-md font-light hover:opacity-80">
                  Myeik Township
                </p>
                <p class="text-md font-light hover:opacity-80">
                  Tanithary Region
                </p>
                <p class="text-md font-light hover:opacity-80">Myanmar</p>
                <p class="text-md font-light hover:opacity-80">
                  Postal Code - 14051
                </p>
              </div>
            </div>
          </div>
        </div>
        <div id="bottom" class="flex w-full mt-7">
          <p class="w-full border-t-2 border-black"></p>
          <p class="w-full text-center pb-5">2024@All right reserved.</p>
          <p class="w-full border-t-2 border-black"></p>
        </div>`

        const footer = document.getElementById("footer");

        footer.innerHTML = footerInnerHtml;